<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Carbon Emission Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>


<style>
body{
  margin: 0;
  font-family: Arial;
  background: #f4f7fb;
  color: #333;
}
header{
  background: #1f78d1;
  color: #fff;
  padding: 16px;
  font-size: 18px; /* Reduced from 20px+ */
  margin-bottom: 25px;
  border-radius: 0 0 10px 10px;
}
.container{
  padding:20px
}
.grid{
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:20px;
}
.card{
  background:#fff;
  padding:15px;
  border-radius:10px;
  box-shadow:0 6px 14px rgba(0,0,0,.1);
}
h3{
  margin-top:0;
  font-size: 17px; /* Matches the About page scale */
  color: #444;
}
.wrap {
  max-width: 1000px;
  margin: 0 auto; /* Centers the dashboard */
  padding: 0 20px;
}
.card {
  background: #fff;
  padding: 20px; /* Reduced padding makes content feel smaller */
  border-radius: 12px;
  box-shadow: 0 6px 14px rgba(0,0,0,.08);
}

/* ================================
   Dashboard Smooth Animations
================================ */

/* Page fade-in */
body {
  animation: fadeIn 0.8s ease-in-out;
}

/* Card slide-up */
.card {
  animation: slideUp 0.8s ease-in-out;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

/* Card hover */
.card:hover {
  transform: translateY(-6px);
  box-shadow: 0 12px 24px rgba(0,0,0,0.15);
}

/* Header animation */
header {
  animation: slideDown 0.7s ease-in-out;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(14px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-14px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Home button styling */
.home-btn {
  margin-top: 10px;
  padding: 14px 26px;
  background: #ffffff;
  color: #1f78d1;
  border: none;
  border-radius: 20px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: background 0.3s ease, transform 0.3s ease;
}

.home-btn:hover {
  background: #e6f0fb;
  transform: translateY(-2px);
}


</style>
</head>

<body>
  <div class="wrap">

<header>
  <h1>Industrial Carbon Emission Dashboard</h1>
  <h3 id="industryName" style="margin:auto 8px;color:#eee;"></h3>
  <h4 id="companyName" style="margin:auto 8px;color:#dbe9f6;"></h4>

  <button class="home-btn" onclick="location.href='index.html'">Home</button>
</header>


<div class="container">
  <div class="grid">
    <div class="card">
      <h3>Total CO₂ Emissions</h3>
      <h2 id="totalCO2">--</h2>
    </div>

    <div class="card">
      <h3>Top Carbon Emission Source</h3>
      <h2 id="topSource">--</h2>
    </div>

    <div class="card">
      <h3>Carbon Emission Breakdown</h3>
      <canvas id="barChart"></canvas>
    </div>

    <div class="card">
      <h3> Carbon Emission Share</h3>
      <canvas id="pieChart"></canvas>
    </div>

    <div class="card">
      <h3>Carbon Emission by Scope</h3>
      <table style="width:100%; border-collapse:collapse; text-align:left;">
        <thead>
      <tr>
      <th style="padding:8px;">Scope</th>
      <th style="padding:8px; text-align:right;">CO₂ Emission (kg)</th>
     </tr>
        </thead>
          <tbody id="scopeTable"></tbody>

      </table>
    </div>


    <div class="card" style="grid-column:1/3">
      <h3>Suggestions</h3>
      <ul id="suggestions"></ul>
          <div class="card">
            <h3>Actionable Insights</h3>
            <p>Download the detailed list of high-emission practices and mitigation measures for your industry.</p>
            <button id="downloadBtn" class="btn" style="background:#21b46b; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer;">
            <i class="fas fa-file-pdf"></i> Download Recommendations
          </button>
        </div>
    </div>
  </div>
</div>
</div>

<script>
// Get selected industry from upload page
const selectedIndustry = localStorage.getItem("industry") || "textile";

const industryEmissionFactors = {
  textile: {
    // Energy
    Electricity: 0.82,        // kg CO2e / kWh
    Diesel: 2.68,             // kg CO2e / litre
    LPG: 3.00,                // kg CO2e / kg
    Steam: 1.90,              // kg CO2e / kg
    TextileWaste: 1.40,       // kg CO2e / kg


    Petrol: 2.31,             // kg CO2e / litre
    
    NaturalGas: 2.20,         // kg CO2e / SCM
    

    // Water & Waste
    Water: 0.344,             // kg CO2e / m3
    
    SolidWaste: 1.20,         // kg CO2e / kg
    WasteWater: 0.70,         // kg CO2e / m3

    // Transport
    TransportDiesel: 0.27,    // kg CO2e / km
    TransportPetrol: 0.24,    // kg CO2e / km

    // Human activity
    EmployeeCommute: 0.21     // kg CO2e / km
  },

  chemical: {
    // Energy
    Electricity: 0.82,        // kg CO2e / kWh
    NaturalGas: 2.20,         // kg CO2e / SCM
    Solvent: 3.50,            // kg CO2e / kg
    HazardousWaste: 4.50,     // kg CO2e / kg


    Diesel: 2.68,             // kg CO2e / litre
    Petrol: 2.31,             // kg CO2e / litre

    // Chemicals & Process
    
    ProcessChemical: 4.10,    // kg CO2e / kg

    // Waste
    
    SolidWaste: 1.20,         // kg CO2e / kg
    WasteWater: 0.70,         // kg CO2e / m3

    // Transport
    TransportDiesel: 0.27,    // kg CO2e / km
    TransportPetrol: 0.24     // kg CO2e / km
  },

  "car-care": {
    Electricity: 0.82,
    CompressedAir: 0.75,
    FilterWaste: 0.50
  }
};

const scopeMapping = {
  Scope1: [
    "Diesel",
    "Petrol",
    "LPG",
    "NaturalGas",
    "Steam",
    "TransportDiesel",
    "CompressedAir",
    "FilterWaste",
    "TransportPetrol",
    "HazardousWaste",
    "TextileWaste",
    "Solvent",
    "ProcessChemical"
  ],
  Scope2: [
    "Electricity"
  ]
};

const priorityActivities = {
  textile: [
    "Electricity",
    "Diesel",
    "LPG",
    "Steam",
    "TextileWaste"
  ],
  chemical: [
    "Electricity",
    "NaturalGas",
    "Solvent",
    "HazardousWaste"
  ],
  "car-care": [
    "Electricity",
    "CompressedAir",
    "FilterWaste"
  ]
};


/* ==============================
   LOAD & PROCESS DATA
============================== */
function loadDashboard(){
  const csv = localStorage.getItem("activityDataCSV");
  const scopeTotals = {
  Scope1: 0,
  Scope2: 0
  };

  if(!csv){
    alert("No CSV data found. Please upload data first.");
    return;
  }

  const rows = parseCSV(csv);
  const totals = {};
  let totalCO2 = 0;

  rows.forEach(r=>{
    const activity = r.Activity?.trim();
    const qty = parseFloat(r.Quantity);
    if(!activity || isNaN(qty)) return;

    if (!priorityActivities[selectedIndustry]?.includes(activity)) return;

   const industryFactors = industryEmissionFactors[selectedIndustry] || {};
   const factor = industryFactors[activity] || 0;

    const co2 = qty * factor;

    totals[activity] = (totals[activity] || 0) + co2;
    totalCO2 += co2;

    if (scopeMapping.Scope1.includes(activity)) {
    scopeTotals.Scope1 += co2;
    }
  if (scopeMapping.Scope2.includes(activity)) {
    scopeTotals.Scope2 += co2;
    }
  });

  // Update KPIs
  document.getElementById("totalCO2").innerText = totalCO2.toFixed(2) + " kg";

  const entries = Object.entries(totals);
  const top = entries.sort((a,b)=>b[1]-a[1])[0];
  document.getElementById("topSource").innerText = top ? top[0] : "N/A";

  renderCharts(entries);
  renderSuggestions(entries, totalCO2);
  renderScopeTable(scopeTotals);

}

function renderScopeTable(scopeTotals){
  const tbody = document.getElementById("scopeTable");
  tbody.innerHTML = "";

  Object.entries(scopeTotals).forEach(([scope, value])=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `
  <td style="padding:8px;">${scope}</td>
  <td style="padding:8px; text-align:right;">${value.toFixed(2)}</td>
`;

    tbody.appendChild(tr);
  });
}


/* ==============================
   CHARTS
============================== */

Chart.register(ChartDataLabels);

function renderCharts(data) {
  const labels = data.map(d => d[0]);
  const values = data.map(d => d[1]);

  // --- BAR CHART ---
  const barCtx = document.getElementById("barChart").getContext("2d");
  new Chart(barCtx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: "CO₂ Emission (kg)",
        data: values,
        backgroundColor: "#1f78d1",
        borderRadius: 5
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      scales: {
        y: {
          beginAtZero: true,
          title: { display: true, text: 'kg CO₂e' }
        }
      },
      plugins: {
        legend: { display: false },
        datalabels: { display: false } // Hide labels on bar chart for cleanliness
      }
    }
  });

  // --- PIE CHART (WITH AUTO-LABELS) ---
  const pieCtx = document.getElementById("pieChart").getContext("2d");
  new Chart(pieCtx, {
    type: 'pie',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: [
          "#4caf50", // Green
          "#ff9800", // Orange
          "#2196f3", // Blue
          "#9c27b0", // Purple
          "#e74c3c", // Red
          "#f1c40f"  // Yellow
        ],
        borderWidth: 2,
        borderColor: '#fff'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          position: 'bottom',
          labels: { padding: 20, boxWidth: 12 }
        },
        datalabels: {
          color: '#fff',
          font: {
            weight: 'bold',
            size: 11 // Smaller font ensures better fit in sections
          },
          // Center the text perfectly in the slice
          anchor: 'center',
          align: 'center',
          offset: 0,
          clip: true,
          formatter: (value, ctx) => {
            // Calculate total to determine percentage share
            let sum = 0;
            let dataArr = ctx.chart.data.datasets[0].data;
            dataArr.map(data => { sum += data; });
            
            let percentageValue = (value * 100 / sum);
            let percentageStr = percentageValue.toFixed(2) + "%"; // Exactly 2 decimals
            
            // HIDE LABELS FOR SMALL SECTIONS:
            // If the slice is less than 4%, the label is hidden to prevent overlap
            return percentageValue > 4 ? percentageStr : null;
          }
        }
      },
      layout: {
        padding: 10
      }
    }
  });
}

/* ==============================
   SUGGESTIONS
============================== */
function renderSuggestions(data, total){
  const ul = document.getElementById("suggestions");
  ul.innerHTML = "";

  if(total > 50000)
    ul.innerHTML += "<li>High emissions detected. Consider renewable energy transition.</li>";

  if(data.some(d=>d[0]==="Electricity"))
    ul.innerHTML += "<li>Switch to solar or energy-efficient motors.</li>";

  if(data.some(d=>d[0]==="Diesel"))
    ul.innerHTML += "<li>Reduce diesel usage or switch to cleaner fuels.</li>";
}

/* ==============================
   CSV PARSER
============================== */
function parseCSV(text){
  const lines = text.trim().split("\n");
  const headers = lines.shift().split(",");
  return lines.map(row=>{
    const values = row.split(",");
    let obj = {};
    headers.forEach((h,i)=>obj[h.trim()] = values[i].trim());
    return obj;
  });
}

window.onload = loadDashboard;
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const industry = localStorage.getItem("industry");
  const company = localStorage.getItem("company");

  if (industry) {
    document.getElementById("industryName").innerText =
      industry.charAt(0).toUpperCase() + industry.slice(1) + " Industry";
  } else {
    document.getElementById("industryName").innerText = "Not Selected";
  }

  if (company) {
    document.getElementById("companyName").innerText = company;
  } else {
    document.getElementById("companyName").innerText = "";
  }
});

/////DOWNLOADING ACTIONABLE INSIGHTS/////////
document.getElementById('downloadBtn').onclick = function() {
    // 1. Get the industry saved from the upload page
    const selectedIndustry = localStorage.getItem("industry"); 

    // 2. Map the ID to your actual PDF file names
    const pdfMap = {
        "textile": "TEXTILE INDUSTRY HIGH CARBON EMISSION PRACTICES.pdf",
        "chemical": "CHEMICAL INDUSTRY HIGH CARBON EMISSION PRACTICES.pdf",
        "car-care": "CAR CARE PRODUCTS INDUSTRY HIGH CARBON EMISSION PRACTICES.pdf"
    };

    const fileName = pdfMap[selectedIndustry];

    if (fileName) {
        // 3. Create a temporary link to trigger the download
        const link = document.createElement('a');
        link.href = `assets/pdfs/${fileName}`; // Ensure your PDFs are in this folder path
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    } else {
        alert("Please complete the audit or select an industry first.");
    }
};

</script>


</body>
</html>
